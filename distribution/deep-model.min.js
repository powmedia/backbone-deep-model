/*jshint expr:true eqnull:true */
/**
 *
 * Backbone.DeepModel v0.10.4
 *
 * Copyright (c) 2013 Charles Davison, Pow Media Ltd
 *
 * https://github.com/powmedia/backbone-deep-model
 * Licensed under the MIT License
 */

;(function(factory) {
    if (typeof define === 'function' && define.amd) {
        // AMD
        define(['underscore', 'backbone'], factory);
    } else {
        // globals
        factory(_, Backbone);
    }
}(function(_, Backbone) {

    (function(e){typeof define=="function"&&define.amd?define(["underscore","backbone"],e):e(_,Backbone)})(function(e,t){function n(t){var r={},i=o.keyPathSeparator;for(var s in t){var u=t[s];if(u&&u.constructor===Object&&!e.isEmpty(u)){var a=n(u);for(var f in a){var l=a[f];r[s+i+f]=l}}else r[s]=u}return r}function r(t,n,r){var i=o.keyPathSeparator,s=n.split(i),u=t;r||r===!1;for(var a=0,f=s.length;a<f;a++){if(r&&!e.has(u,s[a]))return!1;u=u[s[a]],u==null&&a<f-1&&(u={});if(typeof u=="undefined")return r?!0:u}return r?!0:u}function i(t,n,r,i){i=i||{};var s=o.keyPathSeparator,u=n.split(s),a=t;for(var f=0,l=u.length;f<l&&a!==undefined;f++){var c=u[f];if(f===l-1)i.unset?delete a[c]:a[c]=r;else{if(typeof a[c]=="undefined"||!e.isObject(a[c]))a[c]={};a=a[c]}}}function s(e,t){i(e,t,null,{unset:!0})}(function(){var n,r,i,s,o,u,a=[].slice;i=function(n){var r,s;return!e.isObject(n)||e.isFunction(n)?n:n instanceof t.Collection||n instanceof t.Model?n:e.isDate(n)?new Date(n.getTime()):e.isRegExp(n)?new RegExp(n.source,n.toString().replace(/.*\//,"")):(s=e.isArray(n||e.isArguments(n)),r=function(e,t,n){return s?e.push(i(t)):e[n]=i(t),e},e.reduce(n,r,s?[]:{}))},u=function(t){return t==null?!1:(t.prototype==={}.prototype||t.prototype===Object.prototype)&&e.isObject(t)&&!e.isArray(t)&&!e.isFunction(t)&&!e.isDate(t)&&!e.isRegExp(t)&&!e.isArguments(t)},r=function(t){return e.filter(e.keys(t),function(e){return u(t[e])})},n=function(t){return e.filter(e.keys(t),function(n){return e.isArray(t[n])})},o=function(t,i,s){var u,a,f,l,c,h,p,d,v,m;s==null&&(s=20);if(s<=0)return console.warn("_.deepExtend(): Maximum depth of recursion hit."),e.extend(t,i);h=e.intersection(r(t),r(i)),a=function(e){return i[e]=o(t[e],i[e],s-1)};for(p=0,v=h.length;p<v;p++)c=h[p],a(c);l=e.intersection(n(t),n(i)),u=function(n){return i[n]=e.union(t[n],i[n])};for(d=0,m=l.length;d<m;d++)f=l[d],u(f);return e.extend(t,i)},s=function(){var t,n,r,s;r=2<=arguments.length?a.call(arguments,0,s=arguments.length-1):(s=0,[]),n=arguments[s++],e.isNumber(n)||(r.push(n),n=20);if(r.length<=1)return r[0];if(n<=0)return e.extend.apply(this,r);t=r.shift();while(r.length>0)t=o(t,i(r.shift()),n);return t},e.mixin({deepClone:i,isBasicObject:u,basicObjects:r,arrays:n,deepExtend:s})}).call(this);var o=t.Model.extend({constructor:function(t,n){var r,i=t||{};this.cid=e.uniqueId("c"),this.attributes={},n&&n.collection&&(this.collection=n.collection),n&&n.parse&&(i=this.parse(i,n)||{});if(r=e.result(this,"defaults"))i=e.deepExtend({},r,i);this.set(i,n),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(t){return e.deepClone(this.attributes)},get:function(e){return r(this.attributes,e)},set:function(t,u,a){var f,l,c,h,p,d,v,m;if(t==null)return this;typeof t=="object"?(l=t,a=u||{}):(l={})[t]=u,a||(a={});if(!this._validate(l,a))return!1;c=a.unset,p=a.silent,h=[],d=this._changing,this._changing=!0,d||(this._previousAttributes=e.deepClone(this.attributes),this.changed={}),m=this.attributes,v=this._previousAttributes,this.idAttribute in l&&(this.id=l[this.idAttribute]),l=n(l);for(f in l)u=l[f],e.isEqual(r(m,f),u)||h.push(f),e.isEqual(r(v,f),u)?s(this.changed,f):i(this.changed,f,u),c?s(m,f):i(m,f,u);if(!p){h.length&&(this._pending=!0);var g=o.keyPathSeparator;for(var y=0,b=h.length;y<b;y++){var t=h[y];this.trigger("change:"+t,this,r(m,t),a);var w=t.split(g);for(var E=w.length-1;E>0;E--){var S=e.first(w,E).join(g),x=S+g+"*";this.trigger("change:"+x,this,r(m,S),a)}}}if(d)return this;if(!p)while(this._pending)this._pending=!1,this.trigger("change",this,a);return this._pending=!1,this._changing=!1,this},clear:function(t){var r={},i=n(this.attributes);for(var s in i)r[s]=void 0;return this.set(r,e.extend({},t,{unset:!0}))},hasChanged:function(t){return t==null?!e.isEmpty(this.changed):r(this.changed,t)!==undefined},changedAttributes:function(t){if(!t)return this.hasChanged()?n(this.changed):!1;var r=this._changing?this._previousAttributes:this.attributes;t=n(t),r=n(r);var i,s=!1;for(var o in t){if(e.isEqual(r[o],i=t[o]))continue;(s||(s={}))[o]=i}return s},previous:function(e){return e==null||!this._previousAttributes?null:r(this._previousAttributes,e)},previousAttributes:function(){return e.deepClone(this._previousAttributes)}});return o.keyPathSeparator=".",t.DeepModel=o,typeof module!="undefined"&&(module.exports=o),t})

    return Backbone;
}));

